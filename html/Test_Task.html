<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>端API</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <style>
        body {
            background: #fff;
        }

        div {
            font-size: 16px;
        }

        .left {
            display: inline;
            width: 20%;
            line-height: 50px;
            margin: 10px 10% 0 10%;
        }

        .fill {
            width: 100%;
        }
        /*方框框*/

        .right {
            margin: 0 10% 0 0;
            width: 50%;
        }

        .border div {
            font-size: 15px;
            line-height: 37px;
        }
    </style>
    <script type="text/javascript" src="../script/api.js"></script>
    <script type="text/javascript" src="../script/jquery-1.4.2.min.js"></script>
    <script type="text/javascript">
        function closewin() {
            api.closeWin({});

        }

        function submit() {
            var UILoading = api.require('UILoading');
            // var id = 0;

            UILoading.flower({
                center: {
                    x: 160,
                    y: 240
                },
                size: 30,
                fixed: true
            }, function(ret) {
                //alert(JSON.stringify(ret));
            });

            api.ajax({
                url: $api.getStorage('connectUrl') + '/Maintenancer/SubmitPlanCreateTask',
                method: 'post',
                data: {
                    values: {
                        userId: $api.getStorage('userId'),
                        task_id: api.pageParam.task_id

                    }
                }
            }, function(ret, err) {
                var UILoading = api.require('UILoading');
                UILoading.closeFlower({
                    id: 1 //关闭id 号对应加载提示框
                });

                if (ret) {
                    var UILoading = api.require('UILoading');
                    UILoading.closeFlower({
                        id: id++ //关闭id 号对应加载提示框
                    });

                    var project_json = eval(ret);
                    var status = project_json.status;
                    //  alert($api.getStorage('account')+"=="+ api.pageParam.task_type+api.pageParam.project_name+api.pageParam.task_name +api.pageParam.task_character);
                    //  alert(status);
                    if (status == "true") {
                        api.toast({
                            msg: project_json.message,
                            duration: 2000,
                            location: 'bottom'
                        });


                        api.openWin({
                            name: 'index',
                            url: '../index.html',
                            pageParam: {
                                name: 'test'
                            }
                        });

                    } else {
                        // $(this).background=#e0e0e0;
                        api.toast({
                            msg: project_json.message,
                            duration: 2000,
                            location: 'bottom'
                        });
                    }
                }
            });



        }
    </script>

</head>

<body>
    <header class="aui-bar aui-bar-nav" style="background-color:#00b2b4">
        <div class="aui-pull-left aui-btn">
            <span class="aui-iconfont aui-icon-left" onclick="closewin()"></span>
        </div>
        <div class="aui-title">测试任务</div>
    </header>
    <div style="margin-top:20px">
        <div class="left"><b>任务名称</b></div>
        <div style="display:inline;width:50%;" id="getname"></div>
    </div>
    <hr style="margin:0 auto" color=#d3d3d3 width=90% size=3>
    <!-- <HR width="90%" style="margin:0 auto" color=#d3d3d3 SIZE=3> -->
    <div>
        <b style="margin:-0 10%;line-height:60px">业主确认照片</b>
        <img style="margin-left:28%;padding:5px 15px;margin-top:20px;display:inline;width:50px;" src="../image/photo.png" />
    </div>
    <hr style="margin:0 auto;width:90%" color=#d3d3d3 size=3/>
    <div id="project_list">

    </div>
    <p id="submit" class=" define-color" style="margin:50px 40px 40px 40px;border-radius:0.2rem;text-align:center;height:1.5rem;color:#000;padding: 0.3rem 0rem;color:white;font-size:16px;" onclick="submit()">提交</p>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/jquery-1.4.2.min.js"></script>
<script type="text/javascript">
    var project_json = "";
    var id = 0;
    var final_information = "";
    var information = "";
    // var value = '{first_project_id:'+information[i].first_project_id+',first_project_name:'+information[i].first_project_name+',second_project_id:'+second_project_info[j].second_project_id+',second_project_name:'+second_project_info[j].second_project_name+'}';
    apiready = function() {
        //==1代表新建任务页面传过
        information = "";
        information = eval('[' + api.pageParam.array + ']');
        final_information = information;
        // var info = eval(information);
        if (api.pageParam.flag == 1) {
            for (var i = 0; i < information.length; i++) {

                var obj = '<div class="border"> <div style = "margin-top:10px;" ><div class = "left" > <b> 系统名称 </b></div> <div class = "right" style = "red;display:inline"> ' + information[i].first_project_name +
                    '</div></div><div><div class = "left"> <b> 系统分类 </b></div><div class = "right"style = "display:inline"> ' + api.pageParam.task_type +
                    ' </div></div><div><div class = "left" > <b> 设施名称 </b></div><div class = "right" style = "display:inline;"> ' + information[i].second_project_name +
                    ' </div></div><div class = "fill"                    style = "margin-bottom:5px;padding-right:8%;margin-top:-5px;text-align:right;" > <img src = "../image/edit.png"style = "width:28px;margin-bottom:-8px;display:inline" onclick="doclick(' +
                    +i + ',' + i + ')" /> <div style = "display:inline" onclick="doclick(' + i + ',' + i +
                    ')"> 编辑 </div>  <img src = "../image/delete.png"  style = "width:20px;display:inline;margin-bottom:-6px;margin-left:20px" onclick="ddelete()"/> <div style = "display:inline"  onclick="ddelete()"> 删除 </div></div></div>';
                $("#project_list").append(obj);
            }

        } else {

            var UILoading = api.require('UILoading');
            UILoading.flower({
                center: {
                    x: 160,
                    y: 240
                },
                size: 30,
                fixed: true
            }, function(ret) {
                //alert(JSON.stringify(ret));
            });
            api.ajax({
                // url: 'http://192.168.0.7:8080/firefighting/App/AppLogin',
                url: $api.getStorage('connectUrl') + '/Maintenancer/CheckPlanDetail',
                method: 'post',
                dataType: 'text', //该参数若不传，则默认为json<div class="aui-tips aui-margin-b-15">2

                data: {
                    values: {
                        userName: $api.getStorage('account'),


                        //====================这里需要修改
                        maintenanceplan_id: 1
                    } //键值对
                }
            }, function(ret, err) {

                UILoading.closeFlower({
                    id: id++ //关闭id 号对应加载提示框
                });

                if (ret) {
                    //alert(ret);
                    var project_json = $api.strToJson(ret);
                    var status = project_json.status;
                    var role = project_json.status;

                    // var json_str={"status": "true","task":[{"id":123,"project_name":"中建国际中心","create_time":"2017-06-10 15:21","maintenanceplan_name":"2017年1月份计划","task_type":"测试"},{"id":123,"project_name":"名敦道项目","create_time":"2017-06-10 15:21","maintenanceplan_name":"2017年8月份计划","task_type":"排查"},{"id":123,"project_name":"0916项目测试","create_time":"2017-06-10 15:21","maintenanceplan_name":"2017年11月份计划","task_type":"维修"}]};
                    var json_str = $api.strToJson(ret);
                    var data = eval(json_str);
                    var data_status = data.status;
                    var obj = "";


                    if (data_status == "true") {
                        var information = eval(data.unfinished);
                        final_information = eval(data.unfinished);
                        var obj = "";
                        $("#project_list").html("");
                        for (var i = 0; i < information.length; i++) {
                            //使用information[i]来获取一个个的json对象



                            var temp = eval(information[i].second_project);

                            for (var ii = 0; ii < temp.length; ii++) {
                                // obj = '<div class="border"> <div style = "margin-top:10px;" ><div class = "left" > <b> 系统名称 </b></div> <div class = "right" style = "red;display:inline"> ' + information[i].first_project_name +
                                //     '</div></div><div><div class = "left"> <b> 系统分类 </b></div><div class = "right"style = "display:inline"> ' + api.pageParam.task_type +
                                //     ' </div></div><div><div class = "left" > <b> 设施名称 </b></div><div class = "right" style = "display:inline;"> ' + temp[ii].second_project_name +
                                //     ' </div></div><div class = "fill"  style = "margin-bottom:5px;padding-right:8%;margin-top:-5px;text-align:right;"> <img src = "../image/edit.png"style = "width:28px;margin-bottom:-8px;display:inline;"  click="doclick(' +
                                //     information[i].second_project_id + ')/> <div style = "display:inline" click="doclick(' + information[i].second_project_id +
                                //     ')"> 编辑 </div>  <img src = "../image/delete.png" style = "width:20px;display:inline;margin-bottom:-6px;margin-left:20px" /> <div style = "display:inline"> 删除 </div></div></div>';


                                obj = '<div class="border"> <div style = "margin-top:10px;" ><div class = "left" > <b> 系统名称 </b></div> <div class = "right" style = "red;display:inline"> ' + information[i].first_project_name +
                                    '</div></div><div><div class = "left"> <b> 系统分类 </b></div><div class = "right"style = "display:inline"> ' + api.pageParam.task_type +
                                    ' </div></div><div><div class = "left" > <b> 设施名称 </b></div><div class = "right" style = "display:inline;"> ' + temp[ii].second_project_name +
                                    ' </div></div><div class = "fill"                    style = "margin-bottom:5px;padding-right:8%;margin-top:-5px;text-align:right;" > <img src = "../image/edit.png"style = "width:28px;margin-bottom:-8px;display:inline" onclick="doclick(' +
                                    +i + ',' + ii + ')" /> <div style = "display:inline" onclick="doclick(' + i + ',' + ii +
                                    ')"> 编辑 </div>  <img src = "../image/delete.png"  style = "width:20px;display:inline;margin-bottom:-6px;margin-left:20px" /> <div style = "display:inline"> 删除 </div></div></div>';

                                $("#project_list").append(obj);
                            }


                        }
                        information = eval(data.finished);



                        for (var i = 0; i < information.length; i++) {
                            //使用information[i]来获取一个个的json对象
                            temp = eval(information[i].second_project);

                            for (var ii = 0; ii < temp.length; ii++) {
                                obj = '<div class="border"> <div style = "margin-top:10px;" ><div class = "left" > <b> 系统名称 </b></div> <div class = "right" style = "red;display:inline"> ' + information[i].first_project_name +
                                    '</div></div><div><div class = "left"> <b> 系统分类 </b></div><div class = "right"style = "display:inline"> ' + api.pageParam.task_type +
                                    ' </div></div><div><div class = "left" > <b> 设施名称 </b></div><div class = "right" style = "display:inline;"> ' + temp[ii].second_project_name +
                                    ' </div></div></div>';


                                $("#project_list").append(obj);
                            }
                        }

                    } else {
                        api.toast({
                            msg: project_json.message,
                            duration: 2000,
                            location: 'bottom'
                        });
                    }
                    var project_info = api.pageParam.info;
                    $("#name").text(project_info);



                } else {
                    alert("服务器异常，请稍后重试");
                };
            });

        }

        var info = api.pageParam.task_name;

        $("#getname").html(info);
        //为传入的DOM元素增加适当的上内边距，避免header与状态栏重叠
        //设置样式
        api.setStatusBarStyle({
            style: 'dark',
            color: '#6ab494'
        });
        funIniGroup();

        //下方是用来解析json的






        //上方是解析json的
    }

    function ddelete() {
        if (window.confirm('您确定要删除该任务吗？')) {
            //alert("确定");
            return true;
        } else {
            //alert("取消");
            return false;
        }
    }


    function doclick(v, vv) {
        //下方是用来解析json的
        var second_project_id;
        var second_project_name;
        if (api.pageParam.flag == 1) {
            second_project_id = final_information[v].second_project_id;
            second_project_name = final_information[v].second_project_name;

        } else {
            second_project_id = eval(final_information[v].second_project)[vv].second_project_id;
            second_project_name = eval(final_information[v].second_project)[vv].second_project_name;
        }

        api.openWin({
            name: 'testwork10_frm',
            url: './testwork10_frm.html',
            pageParam: {
                name: 'test',
                task_type: api.pageParam.task_type,
                project_name: api.pageParam.project_name,
                task_name: api.pageParam.task_name,
                second_project_id: second_project_id,
                task_character: api.pageParam.task_character,
                second_project_name: second_project_name
            }
        });

        // var temp = eval(information[i].second_project);
    }


    function funIniGroup() {

        var eHeaderLis = $api.domAll('li'),
            frames = [];
        api.openFrameGroup({
            name: 'group',
            scrollEnabled: false,
            rect: {
                x: 0,
                y: 0,
                w: api.winWidth,
                // h: $api.dom('#main').offsetHeight
            },
            index: 0,
            frames: frames
        }, function(ret, err) {

        });
    }

    // 随意切换按钮
    function randomSwitchBtn(tag) {
        if (tag == $api.dom('#footer li.active')) return;
        var eFootLis = $api.domAll('#footer li'),
            eHeaderLis = $api.domAll('header li'),
            index = 0;
        for (var i = 0, len = eFootLis.length; i < len; i++) {
            if (tag == eFootLis[i]) {
                index = i;
            } else {
                $api.removeCls(eFootLis[i], 'active');
                $api.removeCls(eHeaderLis[i], 'active');
            }
        }
        $api.addCls(eFootLis[index], 'active');
        $api.addCls(eHeaderLis[index], 'active');
        api.setFrameGroupIndex({
            name: 'group',
            index: index
        });
    }
</script>

</html>
